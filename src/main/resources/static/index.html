<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kain Na! - Food Delivery API Workshop</title>
  <style>
    /* Fallback styles when JS/Tailwind unavailable */
    :root {
      --green-600: #16a34a;
      --red-500: #ef4444;
      --amber-500: #f59e0b;
      --amber-50: #fffbeb;
      --amber-700: #b45309;
      --slate-50: #f8fafc;
      --slate-100: #f1f5f9;
      --slate-200: #e2e8f0;
      --slate-600: #475569;
      --slate-700: #334155;
      --slate-800: #1e293b;
      --slate-900: #0f172a;
      --orange-600: #ea580c;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--slate-50);
      color: var(--slate-800);
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }
    .card-fallback {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .grid-fallback {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .badge-fallback {
      display: inline-block;
      padding: 0.125rem 0.625rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .container-fallback {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1rem;
    }
    [x-cloak] { display: none !important; }
  </style>
  <script src="vendor/tailwind.min.js"></script>
  <script>
    if (typeof tailwind !== 'undefined') {
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#fef7ee',
                100: '#fdedd3',
                200: '#f9d7a5',
                300: '#f5b96d',
                400: '#ef9233',
                500: '#ec7a12',
                600: '#dd6008',
                700: '#b74809',
                800: '#92390e',
                900: '#76300f',
              }
            }
          }
        }
      }
    }
  </script>
  <script defer src="vendor/alpine.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

<!-- Header -->
<header class="bg-gradient-to-r from-orange-600 to-red-600 text-white shadow-lg">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold tracking-tight">Kain Na! Food Delivery</h1>
        <p class="text-orange-100 mt-1 text-sm">Kotlin + Ktor API Workshop Dashboard</p>
      </div>
      <div class="text-right text-sm text-orange-100">
        <div>API Base: <code class="bg-white/20 px-2 py-0.5 rounded font-mono text-xs">http://localhost:8080/api</code></div>
      </div>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 space-y-8">

  <!-- ==================== PROGRESS TRACKER ==================== -->
  <section x-data="progressTracker()" x-init="checkAll()">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-slate-900">Workshop Progress</h2>
        <button @click="checkAll()"
          class="inline-flex items-center gap-2 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white text-sm font-medium rounded-lg transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          Refresh Progress
        </button>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
        <template x-for="ex in exercises" :key="ex.id">
          <div class="flex items-center gap-2 p-3 rounded-lg border transition-colors"
               :class="ex.status === 'pass' ? 'bg-green-50 border-green-200' : ex.status === 'fail' ? 'bg-red-50 border-red-200' : 'bg-slate-50 border-slate-200'">
            <span x-show="ex.status === 'pass'" class="text-green-600 text-lg font-bold">&#10003;</span>
            <span x-show="ex.status === 'fail'" class="text-red-500 text-lg font-bold">&#10007;</span>
            <span x-show="ex.status === 'checking'" class="text-slate-400 text-sm">...</span>
            <div class="min-w-0">
              <div class="text-xs font-bold text-slate-500" x-text="ex.id"></div>
              <div class="text-sm font-medium truncate" x-text="ex.label"
                   :class="ex.status === 'pass' ? 'text-green-700' : ex.status === 'fail' ? 'text-red-600' : 'text-slate-600'"></div>
            </div>
          </div>
        </template>
      </div>
      <div class="mt-4 flex items-center gap-3">
        <div class="flex-1 bg-slate-100 rounded-full h-3 overflow-hidden">
          <div class="bg-gradient-to-r from-green-500 to-emerald-500 h-3 rounded-full transition-all duration-500"
               :style="'width:' + Math.round(passCount / exercises.length * 100) + '%'"></div>
        </div>
        <span class="text-sm font-semibold text-slate-600" x-text="passCount + '/' + exercises.length + ' complete'"></span>
      </div>
    </div>
  </section>

  <!-- ==================== RESTAURANTS ==================== -->
  <section x-data="restaurantsSection()" x-init="loadRestaurants()">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-center gap-3 mb-4">
        <h2 class="text-xl font-bold text-slate-900">Restaurants</h2>
        <span x-show="restaurants.length > 0" class="inline-flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full bg-green-100 text-green-700">&#10003; Loaded</span>
      </div>

      <!-- Error / exercise prompt -->
      <div x-show="error" class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
        <p class="text-amber-800 font-medium">Complete the Restaurants exercises to unlock this section!</p>
        <p class="text-amber-600 text-sm mt-1" x-text="error"></p>
      </div>

      <!-- Restaurant list -->
      <div x-show="restaurants.length > 0">
        <div class="flex flex-wrap gap-2 mb-4">
          <template x-for="r in restaurants" :key="r.id">
            <button @click="selectRestaurant(r)"
              class="px-4 py-2 rounded-lg text-sm font-medium transition-colors border"
              :class="selected && selected.id === r.id ? 'bg-orange-600 text-white border-orange-600' : 'bg-white text-slate-700 border-slate-300 hover:border-orange-400'">
              <span x-text="r.name"></span>
              <span class="ml-1 text-xs opacity-75" x-text="'&#9733; ' + (r.rating || '')"></span>
            </button>
          </template>
        </div>

        <!-- Menu filters -->
        <div x-show="selected" class="mb-4">
          <h3 class="text-lg font-semibold text-slate-700 mb-2">
            Menu for <span x-text="selected ? selected.name : ''" class="text-orange-600"></span>
          </h3>
          <div class="flex flex-wrap gap-3 mb-4">
            <div>
              <label class="block text-xs font-medium text-slate-500 mb-1">Max Price (&#8369;)</label>
              <input type="number" x-model="maxPrice" @input.debounce.400ms="loadMenu()"
                class="w-32 px-3 py-1.5 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-400" placeholder="e.g. 200">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-500 mb-1">Dietary</label>
              <input type="text" x-model="dietary" @input.debounce.400ms="loadMenu()"
                class="w-40 px-3 py-1.5 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-400" placeholder="e.g. vegetarian">
            </div>
          </div>

          <!-- Menu filter error -->
          <div x-show="menuError && !menuFilterError" class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
            <p class="text-amber-800 font-medium">Complete Exercise 1A: Menu Filter to see filtered results!</p>
            <p class="text-amber-600 text-sm mt-1" x-text="menuError"></p>
          </div>
          <div x-show="menuFilterError" class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
            <p class="text-red-600 text-sm" x-text="menuFilterError"></p>
          </div>

          <!-- Menu items grid -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            <template x-for="item in menu" :key="item.name">
              <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start">
                  <h4 class="font-semibold text-slate-800" x-text="item.name"></h4>
                  <span class="text-orange-600 font-bold whitespace-nowrap" x-text="'&#8369;' + (item.price || 0).toFixed(2)"></span>
                </div>
                <p class="text-sm text-slate-500 mt-1" x-text="item.description || ''"></p>
                <div x-show="item.dietary" class="mt-2">
                  <template x-for="d in (item.dietary || [])" :key="d">
                    <span class="inline-block text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full mr-1" x-text="d"></span>
                  </template>
                </div>
              </div>
            </template>
          </div>
          <p x-show="menu.length === 0 && !menuError" class="text-slate-400 text-sm italic mt-2">No menu items match the filters.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ==================== ORDERS ==================== -->
  <section x-data="ordersSection()" x-init="loadOrders()">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-center gap-3 mb-4">
        <h2 class="text-xl font-bold text-slate-900">Orders</h2>
        <span x-show="orders.length > 0" class="inline-flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full bg-green-100 text-green-700">&#10003; Loaded</span>
        <button x-show="orders.length > 0" @click="loadOrders()" class="ml-auto text-sm text-orange-600 hover:text-orange-800 font-medium">Reload</button>
      </div>

      <!-- Error -->
      <div x-show="error" class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
        <p class="text-amber-800 font-medium">Complete the Orders exercises to unlock this section!</p>
        <p class="text-amber-600 text-sm mt-1" x-text="error"></p>
      </div>

      <!-- Orders list -->
      <div x-show="orders.length > 0" class="space-y-4">
        <template x-for="order in orders" :key="order.id">
          <div class="border border-slate-200 rounded-lg p-4">
            <div class="flex flex-wrap items-center gap-3 mb-2">
              <span class="font-bold text-slate-700" x-text="'Order #' + order.id"></span>
              <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full"
                :class="{
                  'bg-blue-100 text-blue-700': order.status === 'Placed',
                  'bg-yellow-100 text-yellow-700': order.status === 'Preparing',
                  'bg-purple-100 text-purple-700': order.status === 'OutForDelivery',
                  'bg-green-100 text-green-700': order.status === 'Delivered',
                  'bg-red-100 text-red-700': order.status === 'Cancelled'
                }"
                x-text="order.status"></span>
              <span class="text-sm text-slate-500" x-text="order.restaurantId ? 'Restaurant #' + order.restaurantId : ''"></span>
              <span x-show="order._total != null" class="ml-auto text-lg font-bold text-orange-600" x-text="'&#8369;' + (order._total || 0).toFixed(2)"></span>
              <span x-show="order._totalError" class="ml-auto">
                <span class="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full">Exercise 1B: Order Total</span>
              </span>
            </div>
            <!-- Items -->
            <div class="flex flex-wrap gap-2 mb-3">
              <template x-for="item in (order.items || [])" :key="item.menuItemName">
                <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">
                  <span x-text="item.menuItemName"></span> &times;<span x-text="item.quantity"></span>
                </span>
              </template>
            </div>
            <!-- Actions -->
            <div class="flex flex-wrap gap-2">
              <button
                x-show="order.status && !['Delivered','Cancelled'].includes(order.status)"
                @click="advanceStatus(order)"
                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition-colors">
                Advance Status
              </button>
              <button
                x-show="order.status && !['Delivered','Cancelled'].includes(order.status)"
                @click="cancelOrder(order)"
                class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-xs font-medium rounded-lg transition-colors">
                Cancel
              </button>
              <span x-show="order._statusMsg" class="text-xs self-center"
                :class="order._statusOk ? 'text-green-600' : 'text-red-500'"
                x-text="order._statusMsg"></span>
            </div>
          </div>
        </template>
      </div>
    </div>
  </section>

  <!-- ==================== DELIVERY ==================== -->
  <section x-data="deliverySection()" x-init="loadOrders()">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-center gap-3 mb-4">
        <h2 class="text-xl font-bold text-slate-900">Delivery Fee Calculator</h2>
      </div>

      <div class="flex flex-wrap items-end gap-4 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">Select Order</label>
          <select x-model="selectedOrderId" @change="fetchFee()"
            class="px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-400">
            <option value="">-- choose an order --</option>
            <template x-for="o in orders" :key="o.id">
              <option :value="o.id" x-text="'Order #' + o.id + ' (' + o.status + ')'"></option>
            </template>
          </select>
        </div>
      </div>

      <!-- Error -->
      <div x-show="error" class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
        <p class="text-amber-800 font-medium">Complete Exercise 2B: Delivery Fee to unlock this!</p>
        <p class="text-amber-600 text-sm mt-1" x-text="error"></p>
      </div>

      <div x-show="ordersError" class="bg-amber-50 border border-amber-200 rounded-lg p-4">
        <p class="text-amber-800 font-medium">Orders endpoint not available yet.</p>
        <p class="text-amber-600 text-sm mt-1" x-text="ordersError"></p>
      </div>

      <!-- Fee result -->
      <div x-show="fee" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-slate-50 rounded-lg p-4 text-center">
          <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Distance</div>
          <div class="text-2xl font-bold text-slate-800" x-text="(fee.distance || fee.distanceKm || 0) + ' km'"></div>
        </div>
        <div class="bg-slate-50 rounded-lg p-4 text-center">
          <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Fee Tier</div>
          <div class="text-2xl font-bold text-slate-800" x-text="fee.tier || fee.feeTier || '—'"></div>
        </div>
        <div class="bg-orange-50 rounded-lg p-4 text-center">
          <div class="text-xs uppercase tracking-wide text-orange-600 mb-1">Delivery Fee</div>
          <div class="text-2xl font-bold text-orange-600" x-text="'&#8369;' + (fee.fee || fee.deliveryFee || 0).toFixed(2)"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ==================== SEARCH ==================== -->
  <section x-data="searchSection()">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-center gap-3 mb-4">
        <h2 class="text-xl font-bold text-slate-900">Restaurant Search</h2>
      </div>

      <div class="flex flex-wrap gap-3 mb-4">
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">Cuisine</label>
          <input type="text" x-model="cuisine"
            class="w-40 px-3 py-1.5 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-400"
            placeholder="e.g. Filipino">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">Min Rating</label>
          <input type="number" step="0.1" min="0" max="5" x-model="minRating"
            class="w-28 px-3 py-1.5 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-400"
            placeholder="e.g. 4.0">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">Max Delivery Time (min)</label>
          <input type="number" x-model="maxDeliveryTime"
            class="w-36 px-3 py-1.5 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-400"
            placeholder="e.g. 45">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">Sort By</label>
          <select x-model="sortBy"
            class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-400">
            <option value="">Default</option>
            <option value="rating">Rating</option>
            <option value="deliveryTime">Delivery Time</option>
            <option value="name">Name</option>
          </select>
        </div>
        <div class="flex items-end">
          <button @click="search()"
            class="px-5 py-1.5 bg-orange-600 hover:bg-orange-700 text-white text-sm font-medium rounded-lg transition-colors">
            Search
          </button>
        </div>
      </div>

      <!-- Error -->
      <div x-show="error" class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
        <p class="text-amber-800 font-medium">Complete Exercise 3A: Search to unlock this!</p>
        <p class="text-amber-600 text-sm mt-1" x-text="error"></p>
      </div>

      <!-- Results -->
      <div x-show="results.length > 0" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <template x-for="r in results" :key="r.id">
          <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <h4 class="font-semibold text-slate-800" x-text="r.name"></h4>
            <div class="flex items-center gap-2 mt-1 text-sm text-slate-500">
              <span x-text="r.cuisine || ''"></span>
              <span>&middot;</span>
              <span class="text-yellow-600 font-semibold" x-text="'&#9733; ' + (r.rating || '—')"></span>
              <span x-show="r.deliveryTimeMinutes">&middot;</span>
              <span x-show="r.deliveryTimeMinutes" x-text="r.deliveryTimeMinutes + ' min'"></span>
            </div>
            <p class="text-xs text-slate-400 mt-1" x-text="r.address || ''"></p>
          </div>
        </template>
      </div>
      <p x-show="searched && results.length === 0 && !error" class="text-slate-400 text-sm italic">No restaurants match the criteria.</p>
    </div>
  </section>

  <!-- ==================== ANALYTICS ==================== -->
  <section x-data="analyticsSection()" x-init="loadAnalytics()">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-center gap-3 mb-4">
        <h2 class="text-xl font-bold text-slate-900">Analytics Dashboard</h2>
        <span x-show="data" class="inline-flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full bg-green-100 text-green-700">&#10003; Loaded</span>
        <button @click="loadAnalytics()" class="ml-auto text-sm text-orange-600 hover:text-orange-800 font-medium">Reload</button>
      </div>

      <!-- Error -->
      <div x-show="error" class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
        <p class="text-amber-800 font-medium">Complete Exercise 3B: Analytics to unlock this!</p>
        <p class="text-amber-600 text-sm mt-1" x-text="error"></p>
      </div>

      <div x-show="data">
        <!-- Summary cards -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
          <div class="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-lg p-5 text-center">
            <div class="text-xs uppercase tracking-wide text-green-600 mb-1">Total Revenue</div>
            <div class="text-3xl font-bold text-green-700" x-text="data ? '&#8369;' + (data.totalRevenue || 0).toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2}) : ''"></div>
          </div>
          <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-5 text-center">
            <div class="text-xs uppercase tracking-wide text-blue-600 mb-1">Total Orders</div>
            <div class="text-3xl font-bold text-blue-700" x-text="data ? data.totalOrders : ''"></div>
          </div>
          <div class="bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-200 rounded-lg p-5 text-center">
            <div class="text-xs uppercase tracking-wide text-orange-600 mb-1">Avg Order Value</div>
            <div class="text-3xl font-bold text-orange-700" x-text="data ? '&#8369;' + (data.averageOrderValue || 0).toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2}) : ''"></div>
          </div>
        </div>

        <!-- Top Items -->
        <div x-show="data && data.topItems && data.topItems.length" class="mb-6">
          <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-3">Top Items</h3>
          <div class="space-y-2">
            <template x-for="item in (data ? data.topItems || [] : [])" :key="item.name || item.menuItemName">
              <div class="flex items-center gap-3">
                <span class="w-40 text-sm font-medium text-slate-700 truncate" x-text="item.name || item.menuItemName"></span>
                <div class="flex-1 bg-slate-100 rounded-full h-5 overflow-hidden">
                  <div class="bg-gradient-to-r from-orange-400 to-red-400 h-5 rounded-full transition-all"
                    :style="'width:' + (data.topItems.length ? Math.round((item.totalQuantity || item.quantity || 0) / Math.max(...data.topItems.map(i => i.totalQuantity || i.quantity || 1)) * 100) : 0) + '%'"></div>
                </div>
                <span class="text-sm font-semibold text-slate-600 w-16 text-right" x-text="(item.totalQuantity || item.quantity || 0) + ' sold'"></span>
              </div>
            </template>
          </div>
        </div>

        <!-- Orders by Status -->
        <div x-show="data && data.ordersByStatus" class="mb-6">
          <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-3">Orders by Status</h3>
          <div class="flex flex-wrap gap-3">
            <template x-for="(count, status) in (data ? data.ordersByStatus || {} : {})" :key="status">
              <div class="flex-1 min-w-[120px] text-center border rounded-lg p-3"
                :class="{
                  'bg-blue-50 border-blue-200': status === 'Placed',
                  'bg-yellow-50 border-yellow-200': status === 'Preparing',
                  'bg-purple-50 border-purple-200': status === 'OutForDelivery',
                  'bg-green-50 border-green-200': status === 'Delivered',
                  'bg-red-50 border-red-200': status === 'Cancelled'
                }">
                <div class="text-2xl font-bold" x-text="count"></div>
                <div class="text-xs font-medium text-slate-500" x-text="status"></div>
              </div>
            </template>
          </div>
        </div>

        <!-- Revenue by Restaurant -->
        <div x-show="data && data.revenueByRestaurant">
          <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-3">Revenue by Restaurant</h3>
          <div class="space-y-2">
            <template x-for="(revenue, name) in (data ? data.revenueByRestaurant || {} : {})" :key="name">
              <div class="flex items-center gap-3">
                <span class="w-48 text-sm font-medium text-slate-700 truncate" x-text="name"></span>
                <div class="flex-1 bg-slate-100 rounded-full h-5 overflow-hidden">
                  <div class="bg-gradient-to-r from-green-400 to-emerald-500 h-5 rounded-full transition-all"
                    :style="'width:' + (() => { const vals = Object.values(data.revenueByRestaurant||{}); const mx = Math.max(...vals, 1); return Math.round(revenue / mx * 100); })() + '%'"></div>
                </div>
                <span class="text-sm font-semibold text-slate-600 w-28 text-right" x-text="'&#8369;' + (revenue || 0).toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2})"></span>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- Footer -->
<footer class="bg-slate-800 text-slate-400 text-center py-6 mt-12 text-sm">
  <p>Kain Na! Food Delivery &mdash; Kotlin + Ktor Workshop</p>
  <p class="text-slate-500 text-xs mt-1">Prices in Philippine Peso (&#8369;)</p>
</footer>

<script>
// ---- Helpers ----
async function apiFetch(url, options = {}) {
  const res = await fetch(url, options);
  if (!res.ok) {
    let msg = res.statusText;
    try { const body = await res.json(); msg = body.message || body.error || JSON.stringify(body); } catch {}
    throw new Error(msg);
  }
  return res.json();
}

const NEXT_STATUS = {
  'Placed': 'Preparing',
  'Preparing': 'OutForDelivery',
  'OutForDelivery': 'Delivered'
};

// ---- Progress Tracker ----
function progressTracker() {
  return {
    exercises: [
      { id: '1A', label: 'Menu Filter', status: 'checking' },
      { id: '1B', label: 'Order Total', status: 'checking' },
      { id: '2A', label: 'Status Transitions', status: 'checking' },
      { id: '2B', label: 'Delivery Fee', status: 'checking' },
      { id: '3A', label: 'Search', status: 'checking' },
      { id: '3B', label: 'Analytics', status: 'checking' },
    ],
    get passCount() { return this.exercises.filter(e => e.status === 'pass').length; },
    async checkAll() {
      this.exercises.forEach(e => e.status = 'checking');
      // 1A: Menu Filter - need a restaurant id, try to get from restaurants list
      const check = async (idx, fn) => { try { await fn(); this.exercises[idx].status = 'pass'; } catch { this.exercises[idx].status = 'fail'; } };

      let restaurantId = 1;
      let orderId = 1;
      try {
        const restaurants = await apiFetch('/api/restaurants');
        if (restaurants.length > 0) restaurantId = restaurants[0].id;
      } catch {}
      try {
        const orders = await apiFetch('/api/orders');
        if (orders.length > 0) orderId = orders[0].id;
      } catch {}

      await Promise.all([
        // 1A: Menu filter - must test with dietary param (triggers null-safety bug)
        //     AND verify price filter returns correct items (not inverted)
        check(0, async () => {
          // Test dietary filter with items that have null tags (Jollibee)
          const items = await apiFetch('/api/restaurants/resto-2/menu?dietary=vegetarian');
          // Also test price filter returns items AT or BELOW price
          const priceItems = await apiFetch('/api/restaurants/resto-1/menu?maxPrice=100');
          if (priceItems.some(i => i.price > 100)) throw new Error('Price filter still broken');
          if (priceItems.length === 0) throw new Error('Price filter returns no items');
        }),
        // 1B: Order total - verify the math is correct (price × quantity + discount)
        check(1, async () => {
          const data = await apiFetch('/api/orders/order-1/total');
          const total = parseFloat(data.total);
          // Order 1: (149×2)+(89×1)+(25×2) = 437 (no discount, under 500)
          if (Math.abs(total - 437.0) > 1) throw new Error('Total is wrong: ' + total + ', expected 437');
        }),
        // 2A: Status transitions - try an invalid transition to test that validation works
        //     (Delivered → Placed should fail with a specific error, not "Not implemented")
        check(2, async () => {
          const orders = await apiFetch('/api/orders');
          const delivered = orders.find(o => o.status === 'Delivered');
          if (!delivered) throw new Error('no delivered order');
          const res = await fetch('/api/orders/' + delivered.id + '/status', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ newStatus: 'Placed' })
          });
          const body = await res.json();
          // Should fail, but with a transition error (not "Not implemented")
          if (body.error && body.error.includes('Not implemented')) throw new Error('Not implemented yet');
          if (body.error && body.error.includes('Cannot transition')) {
            // This means canTransitionTo() works correctly! The endpoint is implemented.
            return;
          }
          // If it somehow succeeded (bad), or returned unexpected error
          if (res.ok) throw new Error('Should have rejected Delivered→Placed');
        }),
        // 2B: Delivery fee - must return a valid fee result with distance > 0
        check(3, async () => {
          const data = await apiFetch('/api/orders/order-1/delivery-fee');
          if (!data.distanceKm && !data.distance) throw new Error('No distance in response');
          if (data.fee === undefined && data.deliveryFee === undefined) throw new Error('No fee in response');
        }),
        // 3A: Search - must return actual results (not empty)
        check(4, async () => {
          const results = await apiFetch('/api/restaurants/search?cuisine=Filipino');
          if (!Array.isArray(results) || results.length === 0) throw new Error('Search returned no results');
          if (!results.every(r => r.cuisine === 'Filipino')) throw new Error('Search filter not working');
        }),
        // 3B: Analytics - must have non-zero values
        check(5, async () => {
          const data = await apiFetch('/api/analytics/summary');
          if (!data.totalOrders || data.totalOrders === 0) throw new Error('No order count');
          if (!data.totalRevenue || data.totalRevenue === 0) throw new Error('No revenue');
          if (!data.topItems || data.topItems.length === 0) throw new Error('No top items');
        }),
      ]);
    }
  };
}

// ---- Restaurants ----
function restaurantsSection() {
  return {
    restaurants: [],
    selected: null,
    menu: [],
    maxPrice: '',
    dietary: '',
    error: '',
    menuError: '',
    menuFilterError: '',
    async loadRestaurants() {
      this.error = '';
      try {
        this.restaurants = await apiFetch('/api/restaurants');
      } catch (e) {
        this.error = e.message;
      }
    },
    async selectRestaurant(r) {
      this.selected = r;
      this.maxPrice = '';
      this.dietary = '';
      await this.loadMenu();
    },
    async loadMenu() {
      if (!this.selected) return;
      this.menuError = '';
      this.menuFilterError = '';
      let url = '/api/restaurants/' + this.selected.id + '/menu';
      const params = new URLSearchParams();
      if (this.maxPrice) params.set('maxPrice', this.maxPrice);
      if (this.dietary) params.set('dietary', this.dietary);
      const qs = params.toString();
      if (qs) url += '?' + qs;
      try {
        this.menu = await apiFetch(url);
      } catch (e) {
        this.menu = [];
        if (this.maxPrice || this.dietary) {
          this.menuError = e.message;
        } else {
          this.menuFilterError = e.message;
        }
      }
    }
  };
}

// ---- Orders ----
function ordersSection() {
  return {
    orders: [],
    error: '',
    async loadOrders() {
      this.error = '';
      try {
        const orders = await apiFetch('/api/orders');
        // Fetch totals for each order
        this.orders = await Promise.all(orders.map(async (order) => {
          order._total = null;
          order._totalError = false;
          order._statusMsg = '';
          order._statusOk = false;
          try {
            const totalData = await apiFetch('/api/orders/' + order.id + '/total');
            order._total = totalData.total != null ? totalData.total : totalData;
          } catch {
            order._totalError = true;
          }
          return order;
        }));
      } catch (e) {
        this.error = e.message;
      }
    },
    async advanceStatus(order) {
      const next = NEXT_STATUS[order.status];
      if (!next) return;
      order._statusMsg = '';
      try {
        await fetch('/api/orders/' + order.id + '/status', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ newStatus: next })
        }).then(async res => {
          if (!res.ok) {
            const body = await res.json().catch(() => ({}));
            throw new Error(body.message || body.error || res.statusText);
          }
          return res.json().catch(() => ({}));
        });
        order.status = next;
        order._statusMsg = 'Status updated to ' + next;
        order._statusOk = true;
      } catch (e) {
        order._statusMsg = e.message;
        order._statusOk = false;
      }
    },
    async cancelOrder(order) {
      order._statusMsg = '';
      try {
        await fetch('/api/orders/' + order.id + '/status', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ newStatus: 'Cancelled' })
        }).then(async res => {
          if (!res.ok) {
            const body = await res.json().catch(() => ({}));
            throw new Error(body.message || body.error || res.statusText);
          }
          return res.json().catch(() => ({}));
        });
        order.status = 'Cancelled';
        order._statusMsg = 'Order cancelled';
        order._statusOk = true;
      } catch (e) {
        order._statusMsg = e.message;
        order._statusOk = false;
      }
    }
  };
}

// ---- Delivery ----
function deliverySection() {
  return {
    orders: [],
    selectedOrderId: '',
    fee: null,
    error: '',
    ordersError: '',
    async loadOrders() {
      try {
        this.orders = await apiFetch('/api/orders');
      } catch (e) {
        this.ordersError = e.message;
      }
    },
    async fetchFee() {
      if (!this.selectedOrderId) { this.fee = null; this.error = ''; return; }
      this.error = '';
      this.fee = null;
      try {
        this.fee = await apiFetch('/api/orders/' + this.selectedOrderId + '/delivery-fee');
      } catch (e) {
        this.error = e.message;
      }
    }
  };
}

// ---- Search ----
function searchSection() {
  return {
    cuisine: '',
    minRating: '',
    maxDeliveryTime: '',
    sortBy: '',
    results: [],
    error: '',
    searched: false,
    async search() {
      this.error = '';
      this.searched = true;
      const params = new URLSearchParams();
      if (this.cuisine) params.set('cuisine', this.cuisine);
      if (this.minRating) params.set('minRating', this.minRating);
      if (this.maxDeliveryTime) params.set('maxDeliveryTime', this.maxDeliveryTime);
      if (this.sortBy) params.set('sortBy', this.sortBy);
      try {
        this.results = await apiFetch('/api/restaurants/search?' + params.toString());
      } catch (e) {
        this.results = [];
        this.error = e.message;
      }
    }
  };
}

// ---- Analytics ----
function analyticsSection() {
  return {
    data: null,
    error: '',
    async loadAnalytics() {
      this.error = '';
      this.data = null;
      try {
        this.data = await apiFetch('/api/analytics/summary');
      } catch (e) {
        this.error = e.message;
      }
    }
  };
}
</script>

</body>
</html>
